

<form [formGroup]="form" class="clr-form clr-form-compact"
      novalidate>
      <p>
        Select a cluster or resource pool to run this virtual container host.
        <br> Advanced options are available to specify additional requirements.
      </p>
  <section class="form-block mb-0" id='compute-capacity'>

    <div class="clr-form-control clr-row">

        <label class="clr-control-label clr-col-12 clr-col-md-4 required">
          Compute resource
          <b>*</b>
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-6" id="compute-resource-selector">
        <clr-tree>
          <clr-tree-node class="form-control rootNode" *ngFor="let serverInfo of serversInfo">
            <button #btnEl class="clr-treenode-link cc-resource">
              <clr-icon shape="block"></clr-icon>
                {{ serverInfo['name'] }}
            </button>
            <ng-template [clrIfExpanded]="true">
              <ng-container *ngFor="let dc of datacenter">
                <clr-tree-node class="form-control"
                               [class.invalid]="form.invalid && form.getError('invalidComputeResource')"
                               [clrLoading]="isTreeLoading"
                               *ngIf="dc.objRef.indexOf(serverInfo.serviceGuid) > -1">
                    <button class="clr-treenode-link">
                      <clr-icon shape="building"></clr-icon>
                      {{ dc.text }}
                    </button>
                    <ng-template [clrIfExpanded]="true">
                      <vic-compute-resource-treenode #crTreenode
                                                      [serverInfo]="serverInfo"
                                                      [datacenter]="dc"
                                                      (resourceSelected)="selectComputeResource($event)">
                      </vic-compute-resource-treenode>
                    </ng-template>
                </clr-tree-node>
              </ng-container>
            </ng-template>
          </clr-tree-node>
        </clr-tree>
      </div>
    </div>

    <label>
      Virtual Container Host limits
    </label>
    <clr-signpost>
      <clr-signpost-content [clrPosition]="'top-right'" *clrIfOpen>
            <span>
              These limits apply to the resource pool where the VCH is deployed
            </span>
      </clr-signpost-content>
    </clr-signpost>

    <div class="clr-form-control clr-row">

        <label for="cpu-limit-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          CPU
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="cpu-limit-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('cpuLimit').invalid && (form.get('cpuLimit').dirty || form.get('cpuLimit').touched)">

            <div class="clr-input-wrapper">
              <input id="cpu-limit-selector"
                 class="clr-input"
                 type="text"
                 formControlName="cpuLimit">
            </div>
          
          <span class="tooltip-content" *ngIf="form.get('cpuLimit').hasError('required')">
            CPU limit cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuLimit').hasError('pattern')">
            CPU limit should either be 'Unlimited' or a number
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuLimit').hasError('min')">
            CPU limit should be bigger than 0
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuLimit').hasError('max')">
            CPU limit cannot be bigger than {{ resourceLimits['cpu']['maxUsage'] }} MHz
          </span>

          <span class="clr-subtext">Max: {{ resourceLimits.cpu.maxUsage || '-' }} MHz, Min: {{ resourceLimits.cpu.minUsage || '-' }} MHz</span>

        </label>

      </div>

      <span>MHz</span>

    </div>

    <div class="clr-form-control clr-row">

        <label for="memory-limit-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          Memory
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="memory-limit-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('memoryLimit').invalid && (form.get('memoryLimit').dirty || form.get('memoryLimit').touched)">

            <div class="clr-input-wrapper">
              <input id="memory-limit-selector"
              class="clr-input"
              type="text"
              formControlName="memoryLimit">
            </div>

          <span class="tooltip-content" *ngIf="form.get('memoryLimit').hasError('required')">
            Memory limit cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryLimit').hasError('pattern')">
            Memory limit should either be 'Unlimited' or a number
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryLimit').hasError('min')">
            Memory limit should be bigger than 0
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryLimit').hasError('max')">
            Memory limit cannot be bigger than {{ resourceLimits['memory']['maxUsage'] }} MB
          </span>

          <span class="clr-subtext">Max: {{ resourceLimits.memory.maxUsage || '-' }} MB, Min: {{ resourceLimits.memory.minUsage || '-' }} MB</span>


        </label>

      </div>

      <span>MB</span>

    </div>

  </section>

  <a class="advanced btn btn-link pl-0"
     (click)="toggleAdvancedMode()">
    {{ inAdvancedMode ? 'Basic' : 'Advanced' }}
    <clr-icon [attr.shape]="inAdvancedMode ? 'caret up' : 'caret down'"></clr-icon>
  </a>

  <section class="form-block mt-0"
           *ngIf="inAdvancedMode">

    <div class="alert alert-info mb-2">
        <div class="alert-icon-wrapper">
          <clr-icon class="alert-icon" shape="info-circle"></clr-icon>
        </div>
        <div class="alert-text">
          The following options will be used for VCH creation only when the advanced mode is open.
        </div>
     </div>

    <label>
      Virtual Container Host settings
    </label>

    <div class="clr-form-control clr-row">

        <label for="cpu-reservation-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          CPU reservation
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="cpu-reservation-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('cpuReservation').invalid && (form.get('cpuReservation').dirty || form.get('cpuReservation').touched)">

              <div class="clr-input-wrapper">
                <input id="cpu-reservation-selector"
                class="clr-input"
                type="text"
                formControlName="cpuReservation">
              </div>

          <span class="tooltip-content" *ngIf="form.get('cpuReservation').hasError('required')">
            CPU reservation cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuReservation').hasError('pattern')">
            CPU reservation should be numeric
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuReservation').hasError('min')">
            CPU reservation should be bigger than 0
          </span>

          <span class="tooltip-content" *ngIf="form.get('cpuReservation').hasError('max')">
            CPU reservation cannot be bigger than {{ resourceLimits['cpu']['unreservedForPool'] }} MHz
          </span>

          <span class="clr-subtext">Max: {{ resourceLimits.cpu.unreservedForPool || '-' }} MHz, Min: {{ resourceLimits.cpu.minUsage || '-' }} MHz</span>


        </label>

      </div>

      <span>MHz</span>

    </div>

    <div class="clr-form-control clr-row">

        <label for="cpu-shares-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          CPU shares
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <div class="clr-select-wrapper">
          <select id="cpu-shares-selector"
                  class="clr-select"
                  formControlName="cpuShares">
            <option value="low">Low</option>
            <option value="normal">Normal</option>
            <option value="high">High</option>
          </select>
        </div>

      </div>
    </div>

    <div class="clr-form-control clr-row">

        <label for="memory-reservation-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          Memory reservation
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="memory-reservation-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('memoryReservation').invalid && (form.get('memoryReservation').dirty || form.get('memoryReservation').touched)">

              <div class="clr-input-wrapper">
                <input id="memory-reservation-selector"
                class="clr-input"
                type="text"
                formControlName="memoryReservation">
              </div>

          <span class="tooltip-content" *ngIf="form.get('memoryReservation').hasError('required')">
            Memory limit cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryReservation').hasError('pattern')">
            Memory limit should be numeric
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryReservation').hasError('min')">
            Memory limit should be bigger than 0
          </span>

          <span class="tooltip-content" *ngIf="form.get('memoryReservation').hasError('max')">
            Memory limit cannot be bigger than {{ resourceLimits['memory']['unreservedForPool'] }} MB
          </span>

          <span class="clr-subtext">Max: {{ resourceLimits.memory.unreservedForPool || '-' }} MB, Min: {{ resourceLimits.memory.minUsage || '-' }} MB</span>

        </label>

      </div>

      <span>MB</span>

    </div>

    <div class="clr-form-control clr-row">

        <label for="memory-shares-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          Memory shares
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <div class="clr-select-wrapper">
          <select id="memory-shares-selector"
                  class="clr-select"
                  formControlName="memoryShares">
            <option value="low">Low</option>
            <option value="normal">Normal</option>
            <option value="high">High</option>
          </select>
        </div>

      </div>
    </div>

    <label>
      VCH endpoint VM settings
    </label>

    <div class="clr-form-control clr-row">

        <label for="vm-cpu-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          CPUs
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="vm-cpu-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('endpointCpu').invalid && (form.get('endpointCpu').dirty || form.get('endpointCpu').touched)">

          <input id="vm-cpu-selector"
                 class="clr-input"
                 type="text"
                 formControlName="endpointCpu">

          <span class="tooltip-content" *ngIf="form.get('endpointCpu').hasError('required')">
            CPU limit cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('endpointCpu').hasError('pattern')">
            CPU limit should be numeric
          </span>

          <span class="tooltip-content" *ngIf="form.get('endpointCpu').hasError('min')">
            CPU limit should be bigger than 0
          </span>

        </label>

      </div>

    </div>

    <div class="clr-form-control clr-row">

        <label for="vm-memory-selector" class="clr-control-label clr-col-12 clr-col-md-4">
          Memory
        </label>

      <div class="clr-control-container clr-col-12 clr-col-md-3">

        <label for="vm-memory-selector"
               aria-haspopup="true"
               role="tooltip"
               class="form-control tooltip tooltip-validation tooltip-lg tooltip-top-left"
               [class.invalid]="form.get('endpointMemory').invalid && (form.get('endpointMemory').dirty || form.get('endpointMemory').touched)">

              <div class="clr-input-wrapper">
                <input id="vm-memory-selector"
                class="clr-input"
                type="text"
                formControlName="endpointMemory">
              </div>
          
          <span class="tooltip-content" *ngIf="form.get('endpointMemory').hasError('required')">
            Memory limit cannot be empty
          </span>

          <span class="tooltip-content" *ngIf="form.get('endpointMemory').hasError('pattern')">
            Memory limit should be numeric
          </span>

          <span class="tooltip-content" *ngIf="form.get('endpointMemory').hasError('min')">
            Memory limit should be bigger than 0
          </span>

          <span class="tooltip-content" *ngIf="form.get('endpointMemory').hasError('max')">
            Memory limit cannot be bigger than {{ resourceLimits['memory']['maxUsage'] }} MB
          </span>

          <span class="clr-subtext">Max: {{ resourceLimits.memory.maxUsage || '-' }} MB, Min: {{ resourceLimits.memory.minUsage || '-' }} MB</span>

        </label>

      </div>

      <span>MB</span>

    </div>

    <!-- VM-Host Affinity -->
    <ng-container *ngIf="selectedResourceIsCluster">
      <div class="clr-form-control clr-row">
          <label for="vm-host-affinity" class="affinity-label clr-control-label clr-col-12 clr-col-md-4">
            {{ i18n.translate('vch.computeCapacity.vmHostAffinity.title') }}
          </label>
        <div class="clr-control-container clr-col-12 clr-col-md-8">
            <div class="checkbox">
              <input type="checkbox" class="clr-input" id="vm-host-affinity" formControlName="vmHostAffinity"
                   [attr.disabled]="(!vmGroupNameIsValid || !isClusterDrsEnabled) ? '' : null">
              <label class="text-nowrap"
                     [ngClass]="{'affinity-disabled': (!vmGroupNameIsValid || !isClusterDrsEnabled)}"
                     for="vm-host-affinity">
                {{ i18n.translate('vch.computeCapacity.vmHostAffinity.label') }}
              </label>
              <span class="affinity-help">
                <clr-signpost>
                  <clr-signpost-content [clrPosition]="'top-left'" *clrIfOpen>
                  <span>
                    {{ i18n.translate('vch.computeCapacity.vmHostAffinity.info') }}
                  </span>
                  </clr-signpost-content>
                </clr-signpost>
              </span>

              <div class="affinity-alerts" *ngIf="(!isClusterDrsEnabled || !vmGroupNameIsValid)">
                <div class="clr-form-control clr-row">
                  <div class="clr-control-container clr-col-12 clr-col-md-1">
                    <div class="alert-icon-wrapper">
                      <clr-icon class="alert-icon" shape="info-circle"></clr-icon>
                    </div>
                  </div>
                  <div class="clr-control-container clr-col-12 clr-col-md-11">
                    <div class="alert-items">
                      <div class="alert-item static" *ngIf="!vmGroupNameIsValid">
                        <div class="alert-text">
                          {{ i18n.translate('vch.computeCapacity.vmHostAffinity.groupNameError') }}
                        </div>
                      </div>
                      <div class="alert-item static" *ngIf="!isClusterDrsEnabled">
                        <div class="alert-text">
                          {{ i18n.translate('vch.computeCapacity.vmHostAffinity.drsError') }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
        </div>
      </div>

    </ng-container>
    <!-- end -> VM-Host Affinity -->

  </section>
</form>
