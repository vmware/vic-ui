# After any change to this file you MUST re-sign and checkin the .drone.yml.sig
# When you are ready to submit a pull request, you must regenerate .drone.yml.sig for the vmware/vic repo:
# $ export DRONE_SERVER=https://ci.vcna.io
# $ export DRONE_TOKEN=<token>
# $ drone sign vmware/vic-ui
# The secrets file is in our local git repo.  Ask mhagen for access.

---
workspace:
  base: /go
  path: src/github.com/vmware/vic-ui

pipeline:
  clone:
    image: plugins/git
    tags: true
    recursive: false

  clone-pr:
    image: gcr.io/eminent-nation-87317/git-clone:1.1
    pull: true
    environment:
      DRONE_PULL_REQUEST: ${DRONE_PULL_REQUEST}
    when:
      event: [ pull_request ]

  vic-appliance-ui:
    image: gcr.io/eminent-nation-87317/vic-integration-test:1.39
    pull: true
    environment:
      BUILD_NUMBER: ${DRONE_BUILD_NUMBER}
      GS_PROJECT_ID: ${GS_PROJECT_ID}
      GS_CLIENT_EMAIL: ${GS_CLIENT_EMAIL}
      GS_PRIVATE_KEY: ${GS_PRIVATE_KEY}
    commands:
      - make vic-appliance-ui

  publish-vic-appliance-ui:
    image: plugins/gcr
    repo: eminent-nation-87317/vic-appliance-ui
    dockerfile: appliance-ui/Dockerfile
    tags:
      - dev
    json_key: >
      {
        "type": "service_account",
        "project_id": "${GS_PROJECT_ID}",
        "private_key_id": "${GS_PRIVATE_KEY_ID}",
        "private_key": "${GS_PRIVATE_KEY}",
        "client_email": "${GS_CLIENT_EMAIL}",
        "client_id": "${GS_PROJECT_ID}",
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://accounts.google.com/o/oauth2/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_x509_cert_url": ""
      }

    when:
      repo: vmware/vic-ui
      event: [ push, pull_request, tag, deployment ]
      branch: [ master, appliance-ui* ]
      status: success

  vic-ui:
    image: gcr.io/eminent-nation-87317/vic-integration-test:1.36
    pull: true
    environment:
      BUILD_NUMBER: ${DRONE_BUILD_NUMBER}
      BIN: bin
      GS_PROJECT_ID: ${GS_PROJECT_ID}
      GS_CLIENT_EMAIL: ${GS_CLIENT_EMAIL}
      GS_PRIVATE_KEY: ${GS_PRIVATE_KEY}
    commands:
      - make vic-ui-plugins
    when:
      repo: vmware/vic-ui
      branch: [ master, releases/*, refs/tags/* ]

  bundle:
    image: gcr.io/eminent-nation-87317/vic-integration-test:1.36
    pull: true
    environment:
      BIN: bin
      GOPATH: /go
      SHELL: /bin/bash
    commands:
      - mkdir -p $BIN/ui
      - tar -czvf $BIN/vic_ui_${DRONE_BUILD_NUMBER}.tar.gz $BIN/ui
      - mkdir bundle
      - mkdir bundle-release
      - cp $BIN/vic_ui_${DRONE_BUILD_NUMBER}.tar.gz bundle
      - cp $BIN/vic_ui_${DRONE_BUILD_NUMBER}.tar.gz bundle-release/vic_ui_`git describe --tags $(git rev-list --tags --max-count=1)`.tar.gz
      - rm -rf $BIN
      - ls -la bundle
    when:
      repo: vmware/vic-ui
      event: [ push, tag ]
      branch: [ master, releases/*, refs/tags/* ]

  publish-gcs-builds-on-pass:
    image: maplain/drone-gcs:latest
    pull: true
    source: bundle
    target: vic-ui-builds
    acl:
      - allUsers:READER
    cache_control: public,max-age=3600
    when:
      repo: vmware/vic-ui
      event: [ push ]
      branch: [ master, releases/* ]
      status: success

  publish-gcs-releases:
    image: maplain/drone-gcs:latest
    pull: true
    source: bundle-release
    target: vic-ui-releases
    acl:
      - allUsers:READER
    cache_control: public,max-age=3600
    when:
      repo: vmware/vic-ui
      event: [ push, tag ]
      branch: [ refs/tags/* ]
      status: success

services:
  selenium:
    image: selenium/standalone-firefox

